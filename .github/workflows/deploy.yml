name: ðŸš€ Build and Deploy Professor S. Govindasamy Website
# Repository: git@github.com:kgptapps/sgtrust.git
# AWS S3 Deployment URL: https://profsg.org

on:
  push:
    branches: [ main ]
    paths:
      - 'website/**'
      - '.github/workflows/**'
      - 'index.html'
  pull_request:
    branches: [ main ]
    paths:
      - 'website/**'
      - '.github/workflows/**'
      - 'index.html'
  workflow_dispatch: # Allow manual triggering

# Sets permissions of the GITHUB_TOKEN
permissions:
  contents: read
  actions: write
  checks: write
  pull-requests: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "aws-deploy"
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  CACHE_VERSION: 'v1'
  AWS_REGION: ${{ secrets.AWS_REGION }}
  S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
  CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID }}

jobs:
  # Quality checks and build job
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      build-success: ${{ steps.build-check.outputs.success }}
      test-results: ${{ steps.test-summary.outputs.results }}

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better caching

      - name: ðŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: ðŸ“¦ Install dependencies
        run: |
          cd website
          echo "ðŸ” Checking package-lock.json integrity..."
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed successfully"

      - name: ðŸ” Verify installation
        run: |
          cd website
          echo "ðŸ“‹ Installed packages:"
          npm list --depth=0 || true
          echo "ðŸ”§ Node version: $(node --version)"
          echo "ðŸ“¦ NPM version: $(npm --version)"

      - name: ðŸ§ª Run tests (non-blocking)
        run: |
          cd website
          echo "Running tests..."
          npm test -- --run || echo "âš ï¸ Tests failed but continuing build"

      - name: ðŸŒ Run translation coverage tests (non-blocking)
        run: |
          cd website
          echo "Checking translation coverage..."
          npm run test:translations -- --run || echo "âš ï¸ Translation tests failed but continuing build"

      - name: ðŸ” Run linting (non-blocking)
        run: |
          cd website
          echo "Running ESLint..."
          npm run lint || echo "âš ï¸ Linting failed but continuing build"

      - name: ðŸ—ï¸ Build website (CRITICAL)
        run: |
          cd website
          echo "Building website..."
          npm run build
          echo "âœ… Build completed successfully"

      - name: ðŸ” Verify build output
        run: |
          cd website
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Missing dist/index.html"
            exit 1
          fi
          if [ ! -d "dist/assets" ]; then
            echo "âŒ Missing dist/assets directory"
            exit 1
          fi
          echo "âœ… Build output verified"
          echo "ðŸ“Š Build size: $(du -sh dist | cut -f1)"

      - name: â˜ï¸ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸš€ Deploy to S3
        run: |
          cd website
          echo "ðŸš€ Deploying to S3 bucket: ${{ env.S3_BUCKET }}"
          aws s3 sync dist/ s3://${{ env.S3_BUCKET }}/website --delete --exact-timestamps

          echo "ðŸ“„ Setting content types for common file extensions..."
          # Set correct content types for common files
          aws s3 cp s3://${{ env.S3_BUCKET }}/website s3://${{ env.S3_BUCKET }}/website \
            --recursive \
            --exclude "*" \
            --include "*.html" \
            --content-type "text/html" \
            --metadata-directive REPLACE

          aws s3 cp s3://${{ env.S3_BUCKET }}/website s3://${{ env.S3_BUCKET }}/website \
            --recursive \
            --exclude "*" \
            --include "*.css" \
            --content-type "text/css" \
            --metadata-directive REPLACE

          aws s3 cp s3://${{ env.S3_BUCKET }}/website s3://${{ env.S3_BUCKET }}/website \
            --recursive \
            --exclude "*" \
            --include "*.js" \
            --content-type "application/javascript" \
            --metadata-directive REPLACE

          aws s3 cp s3://${{ env.S3_BUCKET }}/website s3://${{ env.S3_BUCKET }}/website \
            --recursive \
            --exclude "*" \
            --include "*.json" \
            --content-type "application/json" \
            --metadata-directive REPLACE

      - name: ðŸ”„ Invalidate CloudFront cache
        if: env.CLOUDFRONT_DISTRIBUTION_ID != ''
        run: |
          echo "ðŸ”„ Invalidating CloudFront distribution: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}"
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)

          echo "â³ Waiting for invalidation $INVALIDATION_ID to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --id $INVALIDATION_ID

          echo "âœ… CloudFront cache invalidation completed"

      - name: ðŸ¥ Health check
        run: |
          echo "ðŸ¥ Performing health check..."
          # Wait a moment for deployment to propagate
          sleep 30

          # Check if the site is accessible
          if [ -n "${{ secrets.DOMAIN_NAME }}" ]; then
            HEALTH_URL="https://${{ secrets.DOMAIN_NAME }}"
            echo "ðŸ” Checking: $HEALTH_URL"

            # Try to access the site
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")

            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Health check passed - Site is accessible"
            else
              echo "âš ï¸ Health check warning - HTTP status: $HTTP_STATUS"
              echo "This might be normal if DNS hasn't propagated yet"
            fi
          else
            echo "â„¹ï¸ No DOMAIN_NAME secret configured, skipping health check"
          fi

      - name: ðŸ“Š Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket**: ${{ env.S3_BUCKET }}/website" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront Distribution**: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ secrets.DOMAIN_NAME }}" ]; then
            echo "- **Website URL**: https://${{ secrets.DOMAIN_NAME }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
